<!DOCTYPE html>
<html>
<head>
    <title>Paris Olympic Opening Ceremony Transportation Planner</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Paris Olympic Opening Ceremony Transportation Planner</h1>
        <div class="form-group">
            <label for="hotel-select">Select Hotel:</label>
            <select class="form-control" id="hotel-select"></select>
        </div>
        <div class="form-group">
            <label for="venue-select">Select Venue:</label>
            <select class="form-control" id="venue-select"></select>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let map;
        let hotels = [];
        let venues = [];
        let psas = [];
        let hotelMarker;
        let venueMarker;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 48.8566, lng: 2.3522 },
                zoom: 12
            });

            Promise.all([
                fetch('https://sheets.googleapis.com/v4/spreadsheets/1fktkp6Osgs08qbYgKorEaZZxdDLq-0LRN3BMw7j_4kQ/values/Hotels?key=AIzaSyBjlGkxN5JMqjBQn0Tb0HY-3hG8ACkITuM'),
                fetch('https://sheets.googleapis.com/v4/spreadsheets/1fktkp6Osgs08qbYgKorEaZZxdDLq-0LRN3BMw7j_4kQ/values/Venues?key=AIzaSyBjlGkxN5JMqjBQn0Tb0HY-3hG8ACkITuM'),
                fetch('https://sheets.googleapis.com/v4/spreadsheets/1fktkp6Osgs08qbYgKorEaZZxdDLq-0LRN3BMw7j_4kQ/values/PSAs?key=AIzaSyBjlGkxN5JMqjBQn0Tb0HY-3hG8ACkITuM')
            ])
            .then(([hotelsResponse, venuesResponse, psasResponse]) => Promise.all([hotelsResponse.json(), venuesResponse.json(), psasResponse.json()]))
            .then(([hotelsData, venuesData, psasData]) => {
                hotels = hotelsData.values.slice(1).map(row => ({
                    name: row[1],
                    location: { lat: parseFloat(row[2]), lng: parseFloat(row[3]) }
                }));
                venues = venuesData.values.slice(1).map(row => ({
                    name: row[1],
                    location: { lat: parseFloat(row[2]), lng: parseFloat(row[3]) }
                }));
                psas = psasData.values.slice(1).map(row => ({
                    name: row[1],
                    location: { lat: parseFloat(row[2]), lng: parseFloat(row[3]) }
                }));

                populateDropdowns();
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
        }

        function populateDropdowns() {
            const hotelSelect = document.getElementById('hotel-select');
            const venueSelect = document.getElementById('venue-select');

            // Add a blank option for hotels
            const hotelBlankOption = document.createElement('option');
            hotelBlankOption.value = '';
            hotelBlankOption.textContent = 'Select a hotel';
            hotelSelect.appendChild(hotelBlankOption);

            // Add a blank option for venues
            const venueBlankOption = document.createElement('option');
            venueBlankOption.value = '';
            venueBlankOption.textContent = 'Select a venue';
            venueSelect.appendChild(venueBlankOption);

            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.name;
                option.textContent = hotel.name;
                hotelSelect.appendChild(option);
            });

            venues.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue.name;
                option.textContent = venue.name;
                venueSelect.appendChild(option);
            });

            hotelSelect.addEventListener('change', displayRoute);
            venueSelect.addEventListener('change', displayRoute);
        }

        function findNearestPSA(location) {
            let nearestPSA = null;
            let minDistance = Infinity;

            psas.forEach(psa => {
                const distance = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(location.location),
                    new google.maps.LatLng(psa.location)
                );

                if (distance < minDistance) {
                    minDistance = distance;
                    nearestPSA = psa;
                }
            });

            return nearestPSA;
        }

        function displayRoute() {
            const selectedHotel = document.getElementById('hotel-select').value;
            const selectedVenue = document.getElementById('venue-select').value;

            if (selectedHotel && selectedVenue) {
                const hotel = hotels.find(hotel => hotel.name === selectedHotel);
                const venue = venues.find(venue => venue.name === selectedVenue);
                const psa = findNearestPSA(hotel);

                if (hotelMarker) {
                    hotelMarker.setMap(null);
                }
                if (venueMarker) {
                    venueMarker.setMap(null);
                }

                hotelMarker = new google.maps.Marker({
                    position: hotel.location,
                    map: map,
                    title: hotel.name
                });

                venueMarker = new google.maps.Marker({
                    position: venue.location,
                    map: map,
                    title: venue.name
                });

                // Add PSA marker
                const psaMarker = new google.maps.Marker({
                    position: psa.location,
                    map: map,
                    title: psa.name,
                    icon: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                });

                const directionsService = new google.maps.DirectionsService();
                const directionsRenderer = new google.maps.DirectionsRenderer();
                directionsRenderer.setMap(map);

                const waypoints = [{ location: psa.location, stopover: true }];

                const request = {
                    origin: hotel.location,
                    destination: venue.location,
                    waypoints: waypoints,
                    optimizeWaypoints: true,
                    travelMode: 'DRIVING'
                };

                directionsService.route(request, function(result, status) {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(result);
                    }
                });

                const bounds = new google.maps.LatLngBounds();
                bounds.extend(hotel.location);
                bounds.extend(venue.location);

                const infoWindow = new google.maps.InfoWindow();
                infoWindow.setContent(`<b>Hotel:</b> ${hotel.name}<br><b>Venue:</b> ${venue.name}`);
                infoWindow.open(map, hotelMarker);

                map.fitBounds(bounds);
            }
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjlGkxN5JMqjBQn0Tb0HY-3hG8ACkITuM&callback=initMap&libraries=geometry" async defer></script>
</body>
</html>
