<!DOCTYPE html>
<html>
<head>
    <title>Paris Olympic Opening Ceremony Transportation Planner</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Paris Olympic Opening Ceremony Transportation Planner</h1>
        <div class="form-group">
            <label for="hotel-select">Select Hotel:</label>
            <select class="form-control" id="hotel-select"></select>
        </div>
        <div class="form-group">
            <label for="venue-select">Select Venue:</label>
            <select class="form-control" id="venue-select"></select>
        </div>
        <button class="btn btn-primary" id="calculate-route-btn">Calculate Best Route</button>
        <div id="map"></div>
        <div id="directions-panel"></div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let map;
        let hotels = [];
        let venues = [];
        let psas = [];
        let hotelMarker;
        let venueMarker;
        let psaMarker;
        let directionsRenderer;
        let directionsService;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 48.8566, lng: 2.3522 },
                zoom: 12
            });

            directionsService = new google.maps.DirectionsService();

            // Define the coordinates for the security perimeter
            const securityPerimeterCoords = [
                { lat: 48.86168, lng: 2.29452 },
                { lat: 48.86072, lng: 2.29675 },
                { lat: 48.85856, lng: 2.30022 },
                { lat: 48.85725, lng: 2.30239 },
                { lat: 48.85635, lng: 2.30389 },
                { lat: 48.85504, lng: 2.30583 },
                { lat: 48.85429, lng: 2.30687 },
                { lat: 48.85344, lng: 2.30737 },
                { lat: 48.85285, lng: 2.30771 },
                { lat: 48.85208, lng: 2.30758 },
                { lat: 48.85119, lng: 2.30765 },
                { lat: 48.85038, lng: 2.30797 },
                { lat: 48.84932, lng: 2.30824 },
                { lat: 48.84825, lng: 2.30838 },
                { lat: 48.84706, lng: 2.30829 },
                { lat: 48.84576, lng: 2.30793 },
                { lat: 48.84447, lng: 2.30769 },
                { lat: 48.84329, lng: 2.30772 },
                { lat: 48.84221, lng: 2.30804 },
                { lat: 48.84117, lng: 2.30843 },
                { lat: 48.84011, lng: 2.30863 },
                { lat: 48.83912, lng: 2.30849 },
                { lat: 48.83815, lng: 2.30846 },
                { lat: 48.83728, lng: 2.30864 },
                { lat: 48.83631, lng: 2.30907 },
                { lat: 48.83547, lng: 2.30965 },
                { lat: 48.83468, lng: 2.31012 },
                { lat: 48.83387, lng: 2.31053 },
                { lat: 48.83314, lng: 2.31099 },
                { lat: 48.83242, lng: 2.31164 },
                { lat: 48.83191, lng: 2.31239 },
                { lat: 48.83161, lng: 2.31316 },
                { lat: 48.83152, lng: 2.31397 },
                { lat: 48.83164, lng: 2.31473 },
                { lat: 48.83184, lng: 2.31564 },
                { lat: 48.83224, lng: 2.31645 },
                { lat: 48.83274, lng: 2.31719 },
                { lat: 48.83328, lng: 2.31783 },
                { lat: 48.83401, lng: 2.31843 },
                { lat: 48.83489, lng: 2.31899 },
                { lat: 48.83584, lng: 2.31945 },
                { lat: 48.83698, lng: 2.31973 },
                { lat: 48.83809, lng: 2.31996 },
                { lat: 48.83929, lng: 2.32023 },
                { lat: 48.84042, lng: 2.32045 },
                { lat: 48.84162, lng: 2.32044 },
                { lat: 48.84278, lng: 2.32023 },
                { lat: 48.84391, lng: 2.31983 },
                { lat: 48.84501, lng: 2.31931 },
                { lat: 48.84615, lng: 2.31899 },
                { lat: 48.84725, lng: 2.31888 },
                { lat: 48.84832, lng: 2.31887 },
                { lat: 48.84936, lng: 2.31884 },
                { lat: 48.85038, lng: 2.31866 },
                { lat: 48.85144, lng: 2.31832 },
                { lat: 48.85253, lng: 2.31787 },
                { lat: 48.85355, lng: 2.31741 },
                { lat: 48.85457, lng: 2.31702 },
                { lat: 48.85565, lng: 2.31687 },
                { lat: 48.85675, lng: 2.31695 },
                { lat: 48.85775, lng: 2.31711 },
                { lat: 48.85889, lng: 2.31732 },
                { lat: 48.86, lng: 2.31744 },
                { lat: 48.86112, lng: 2.31722 },
                { lat: 48.86215, lng: 2.31661 },
                { lat: 48.86301, lng: 2.31587 },
                { lat: 48.86378, lng: 2.31516 },
                { lat: 48.86451, lng: 2.31446 },
                { lat: 48.86512, lng: 2.31367 },
                { lat: 48.86561, lng: 2.31279 },
                { lat: 48.86594, lng: 2.31185 },
                { lat: 48.86609, lng: 2.31093 },
                { lat: 48.86626, lng: 2.30997 },
                { lat: 48.86627, lng: 2.30903 },
                { lat: 48.86598, lng: 2.30818 },
                { lat: 48.86537, lng: 2.30751 },
                { lat: 48.86456, lng: 2.30695 },
                { lat: 48.86366, lng: 2.30632 },
                { lat: 48.86276, lng: 2.30565 },
                { lat: 48.86186, lng: 2.30491 }
            ];

            // Create a new polygon for the security perimeter
            const securityPerimeter = new google.maps.Polygon({
                paths: securityPerimeterCoords,
                strokeColor: '#FF0000', // Red color
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35
            });

            // Add the security perimeter to the map
            securityPerimeter.setMap(map);

            Promise.all([
                fetch('https://sheets.googleapis.com/v4/spreadsheets/1fktkp6Osgs08qbYgKorEaZZxdDLq-0LRN3BMw7j_4kQ/values/Hotels!B2:C51?key=AIzaSyBjlGkxN5JMqjBQn0Tb0HY-3hG8ACkITuM'),
                fetch('https://sheets.googleapis.com/v4/spreadsheets/1fktkp6Osgs08qbYgKorEaZZxdDLq-0LRN3BMw7j_4kQ/values/Venues!B2:C17?key=AIzaSyBjlGkxN5JMqjBQn0Tb0HY-3hG8ACkITuM'),
                fetch('https://sheets.googleapis.com/v4/spreadsheets/1fktkp6Osgs08qbYgKorEaZZxdDLq-0LRN3BMw7j_4kQ/values/PSAs?key=AIzaSyBjlGkxN5JMqjBQn0Tb0HY-3hG8ACkITuM')
            ])
            .then(([hotelsResponse, venuesResponse, psasResponse]) => Promise.all([hotelsResponse.json(), venuesResponse.json(), psasResponse.json()]))
            .then(([hotelsData, venuesData, psasData]) => {
                hotels = hotelsData.values.map(row => ({
                    name: row[0],
                    address: row[1]
                }));
                venues = venuesData.values.map(row => ({
                    name: row[0],
                    address: row[1]
                }));
                psas = psasData.values.slice(1).map(row => ({
                    name: row[1],
                    location: { lat: parseFloat(row[2]), lng: parseFloat(row[3]) }
                })).filter(psa => !isNaN(psa.location.lat) && !isNaN(psa.location.lng));

                console.log('Hotels:', hotels);
                console.log('Venues:', venues);
                console.log('PSAs:', psas);

                populateDropdowns();
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
        }

        function populateDropdowns() {
            const hotelSelect = document.getElementById('hotel-select');
            const venueSelect = document.getElementById('venue-select');

            // Add a blank option for hotels
            const hotelBlankOption = document.createElement('option');
            hotelBlankOption.value = '';
            hotelBlankOption.textContent = 'Select a hotel';
            hotelSelect.appendChild(hotelBlankOption);

            // Add a blank option for venues
            const venueBlankOption = document.createElement('option');
            venueBlankOption.value = '';
            venueBlankOption.textContent = 'Select a venue';
            venueSelect.appendChild(venueBlankOption);

            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.address;
                option.textContent = hotel.name;
                hotelSelect.appendChild(option);
            });

            venues.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue.address;
                option.textContent = venue.name;
                venueSelect.appendChild(option);
            });

            hotelSelect.addEventListener('change', showHotelMarker);
            venueSelect.addEventListener('change', showVenueMarker);
            document.getElementById('calculate-route-btn').addEventListener('click', calculateRoute);
        }

        function showHotelMarker() {
            const selectedHotel = document.getElementById('hotel-select').value;
            const hotelName = document.getElementById('hotel-select').options[document.getElementById('hotel-select').selectedIndex].text;
            if (selectedHotel) {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: selectedHotel }, function(results, status) {
                    if (status === 'OK') {
                        const location = results[0].geometry.location;
                        if (hotelMarker) {
                            hotelMarker.setMap(null);
                        }
                        hotelMarker = new google.maps.Marker({
                            map: map,
                            position: location,
                            title: hotelName || 'Start',
                            icon: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                        });
                        map.setCenter(location);
                        map.setZoom(14);
                    } else {
                        console.error('Geocode was not successful for the following reason:', status);
                    }
                });
            }
        }

        function showVenueMarker() {
            const selectedVenue = document.getElementById('venue-select').value;
            const venueName = document.getElementById('venue-select').options[document.getElementById('venue-select').selectedIndex].text;
            if (selectedVenue) {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: selectedVenue }, function(results, status) {
                    if (status === 'OK') {
                        const location = results[0].geometry.location;
                        if (venueMarker) {
                            venueMarker.setMap(null);
                        }
                        venueMarker = new google.maps.Marker({
                            map: map,
                            position: location,
                            title: venueName || 'Viewing Location',
                            icon: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
                        });
                        map.setCenter(location);
                        map.setZoom(14);
                    } else {
                        console.error('Geocode was not successful for the following reason:', status);
                    }
                });
            }
        }

        function findNearestPSA(location) {
            let nearestPSA = null;
            let minDistance = Infinity;

            psas.forEach(psa => {
                if (psa && psa.location) {
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(
                        new google.maps.LatLng(location),
                        new google.maps.LatLng(psa.location)
                    );

                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestPSA = psa;
                    }
                }
            });

            return nearestPSA;
        }

        function calculateRoute() {
            const selectedHotel = document.getElementById('hotel-select').value;
            const selectedVenue = document.getElementById('venue-select').value;

            if (selectedHotel && selectedVenue) {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: selectedHotel }, function(hotelResults, hotelStatus) {
                    if (hotelStatus === 'OK') {
                        const hotelLocation = hotelResults[0].geometry.location;
                        geocoder.geocode({ address: selectedVenue }, function(venueResults, venueStatus) {
                            if (venueStatus === 'OK') {
                                const venueLocation = venueResults[0].geometry.location;
                                const psa = findNearestPSA(hotelLocation);
                                if (psa && psa.location) {
                                    if (psaMarker) {
                                        psaMarker.setMap(null);
                                    }
                                            const hotelToPSARenderer = new google.maps.DirectionsRenderer({
            polylineOptions: {
                strokeColor: 'blue'
            },
            suppressMarkers: true
        });
        const psaToVenueRenderer = new google.maps.DirectionsRenderer({
            polylineOptions: {
                strokeColor: 'green'
            },
            suppressMarkers: true
        });

        const hotelToPSARequest = {
            origin: hotelLocation,
            destination: psa.location,
            travelMode: 'DRIVING'
        };

        const psaToVenueRequest = {
            origin: psa.location,
            destination: venueLocation,
            travelMode: 'DRIVING'
        };

        directionsService.route(hotelToPSARequest, function(hotelToPSAResult, hotelToPSAStatus) {
            if (hotelToPSAStatus === 'OK') {
                hotelToPSARenderer.setDirections(hotelToPSAResult);
                hotelToPSARenderer.setMap(map);

                directionsService.route(psaToVenueRequest, function(psaToVenueResult, psaToVenueStatus) {
                    if (psaToVenueStatus === 'OK') {
                        psaToVenueRenderer.setDirections(psaToVenueResult);
                        psaToVenueRenderer.setMap(map);

                        const bounds = new google.maps.LatLngBounds();
                        bounds.extend(hotelLocation);
                        bounds.extend(venueLocation);
                        map.fitBounds(bounds);

                        // Display total trip time
                        const totalDuration = hotelToPSAResult.routes[0].legs[0].duration.value + psaToVenueResult.routes[0].legs[0].duration.value;
                        const totalDurationText = formatDuration(totalDuration);
                        document.getElementById('directions-panel').insertAdjacentHTML('beforebegin', `<p>Total Trip Time: ${totalDurationText}</p>`);
                    } else {
                        console.error('Error calculating PSA to Venue route:', psaToVenueStatus);
                    }
                });
            } else {
                console.error('Error calculating Hotel to PSA route:', hotelToPSAStatus);
            }
        });
                                    psaMarker = new google.maps.Marker({
                                        map: map,
                                        position: psa.location,
                                        title: 'PSA',
                                        icon: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                                    });

                                    if (directionsRenderer) {
                                        directionsRenderer.setMap(null);
                                        directionsRenderer.setPanel(null);
                                    }
                                    directionsRenderer = new google.maps.DirectionsRenderer();
                                    directionsRenderer.setMap(map);
                                    directionsRenderer.setPanel(document.getElementById('directions-panel'));

                                    const waypoints = [{ location: psa.location, stopover: true }];

                                    const request = {
                                        origin: hotelLocation,
                                        destination: venueLocation,
                                        waypoints: waypoints,
                                        optimizeWaypoints: true,
                                        travelMode: 'DRIVING'
                                    };

                                    directionsService.route(request, function(result, status) {
                                        if (status === 'OK') {
                                            directionsRenderer.setDirections(result);
                                            const bounds = new google.maps.LatLngBounds();
                                            bounds.extend(hotelLocation);
                                            bounds.extend(venueLocation);
                                            map.fitBounds(bounds);

                                            // Display total trip time
                                            const totalDuration = result.routes[0].legs.reduce((total, leg) => total + leg.duration.value, 0);
                                            const totalDurationText = formatDuration(totalDuration);
                                            document.getElementById('directions-panel').insertAdjacentHTML('beforebegin', `<p>Total Trip Time: ${totalDurationText}</p>`);
                                        } else {
                                            console.error('Error calculating route:', status);
                                        }
                                    });
                                } else {
                                    console.error('Nearest PSA not found or missing location data');
                                }
                            } else {
                                console.error('Geocode was not successful for the venue for the following reason:', venueStatus);
                            }
                        });
                    } else {
                        console.error('Geocode was not successful for the hotel for the following reason:', hotelStatus);
                    }
                });
            }
        }

        function formatDuration(durationInSeconds) {
            const hours = Math.floor(durationInSeconds / 3600);
            const minutes = Math.floor((durationInSeconds % 3600) / 60);
            const seconds = durationInSeconds % 60;

            let durationText = '';
            if (hours > 0) {
                durationText += `${hours} hour${hours > 1 ? 's' : ''} `;
            }
            if (minutes > 0) {
                durationText += `${minutes} minute${minutes > 1 ? 's' : ''} `;
            }
            if (seconds > 0) {
                durationText += `${seconds} second${seconds > 1 ? 's' : ''}`;
            }

            return durationText.trim();
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjlGkxN5JMqjBQn0Tb0HY-3hG8ACkITuM&libraries=geometry&callback=initMap" async defer></script>
</body>
</html>
