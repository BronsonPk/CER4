<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CER1 Hotel to PSA Transportation Plan</title>
  <style>
    #map {
      height: 500px;
    }
  </style>
</head>
<body>
  <h1>CER1 Hotel to PSA Transportation Plan</h1>
  <div>
    <label for="hotel-select">Select Hotel:</label>
    <select id="hotel-select">
      <option value="">Choose a hotel</option>
    </select>
  </div>
  <div>
    <label for="venue-select">Select Venue:</label>
    <select id="venue-select">
      <option value="">Choose a venue</option>
    </select>
  </div>
  <div id="map"></div>
  <div id="directions-panel"></div>

  <script>
    function populateDropdowns(hotels, venues) {
      const hotelSelect = document.getElementById('hotel-select');
      const venueSelect = document.getElementById('venue-select');

      hotels.forEach(hotel => {
        const option = document.createElement('option');
        option.value = hotel[0];
        option.textContent = hotel[1];
        hotelSelect.appendChild(option);
      });

      venues.forEach(venue => {
        const option = document.createElement('option');
        option.value = venue[0];
        option.textContent = venue[1];
        venueSelect.appendChild(option);
      });
    }

    const sheetId = '1fktkp6Osgs08qbYgKorEaZZxdDLq-0LRN3BMw7j_4kQ';
    const apiKey = 'AIzaSyBjlGkxN5JMqjBQn0Tb0HY-3hG8ACkITuM';
    const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values:batchGet?ranges=Hotels!A2:F&ranges=Venues!A2:F&ranges=PSAs!A2:D&key=${apiKey}`;

    let map;
    let directionsRenderer;

    fetch(sheetUrl)
      .then(response => response.json())
      .then(data => {
        const hotels = data.valueRanges[0].values;
        const venues = data.valueRanges[1].values;
        const psas = data.valueRanges[2].values;
        populateDropdowns(hotels, venues);
        initMap(hotels, venues, psas);
      });

    function initMap(hotels, venues, psas) {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 48.8589507, lng: 2.2770205 },
        zoom: 13
      });
      directionsRenderer = new google.maps.DirectionsRenderer();
      directionsRenderer.setMap(map);
    }

    function generateRoute() {
      const selectedHotel = document.getElementById('hotel-select').value;
      const selectedVenue = document.getElementById('venue-select').value;

      if (selectedHotel && selectedVenue) {
        const nearestPSA = findNearestPSA(selectedHotel);
        const hotelToPSARoute = getDirections(selectedHotel, nearestPSA);
        const psaToVenueRoute = getDirections(nearestPSA, selectedVenue);
        displayRoute(hotelToPSARoute, psaToVenueRoute);
      }
    }

    function findNearestPSA(hotelId) {
      const hotel = hotels.find(h => h[0] === hotelId);
      const hotelLat = parseFloat(hotel[4]);
      const hotelLng = parseFloat(hotel[5]);
      let nearestPSA = null;
      let minDistance = Infinity;

      for (const psa of psas) {
        const psaLat = parseFloat(psa[2]);
        const psaLng = parseFloat(psa[3]);
        const distance = getDistance(hotelLat, hotelLng, psaLat, psaLng);

        if (distance < minDistance) {
          minDistance = distance;
          nearestPSA = psa[0];
        }
      }

      return nearestPSA;
    }

    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371; // Earth's radius in kilometers
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distance = R * c;
      return distance;
    }

    function toRad(degrees) {
      return degrees * (Math.PI / 180);
    }

    function getDirections(origin, destination) {
      const directionsService = new google.maps.DirectionsService();
      const request = {
        origin: getLatLng(origin),
        destination: getLatLng(destination),
        travelMode: 'DRIVING'
      };

      return new Promise((resolve, reject) => {
        directionsService.route(request, (result, status) => {
          if (status === 'OK') {
            resolve(result);
          } else {
            reject(new Error('Directions request failed due to ' + status));
          }
        });
      });
    }

    function getLatLng(locationId) {
      const location = [...hotels, ...psas, ...venues].find(l => l[0] === locationId);
      return { lat: parseFloat(location[4]), lng: parseFloat(location[5]) };
    }

    function displayRoute(hotelToPSARoute, psaToVenueRoute) {
      const directionsRenderer = new google.maps.DirectionsRenderer();
      directionsRenderer.setMap(map);
      directionsRenderer.setDirections(hotelToPSARoute);

      const directionsRenderer2 = new google.maps.DirectionsRenderer({
        polylineOptions: {
          strokeColor: 'blue'
        }
      });
      directionsRenderer2.setMap(map);
      directionsRenderer2.setDirections(psaToVenueRoute);
    }

    document.getElementById('hotel-select').addEventListener('change', generateRoute);
    document.getElementById('venue-select').addEventListener('change', generateRoute);
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjlGkxN5JMqjBQn0Tb0HY-3hG8ACkITuM" async defer></script>
</body>
</html>
